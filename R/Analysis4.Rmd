---
title: "Interactive effects of stress and environmental enrichment on anxiety- and depression-like behavior"
authors: "Yefeng Yang & Shinichi Nakagawa"
output:
  rmdformats::downcute:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: true
pkgdown:
  as_is: true   
---

```{r, include = FALSE}
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE,
cache = TRUE, 
tidy = TRUE, 
echo = TRUE
)

rm(list = ls())
```

e# Setting-up

```{r, cache=FALSE, warning=FALSE}
pacman::p_load(tidyverse,
               readxl,
               here,
               clubSandwich,
               MuMIn,
               glmulti,
               metafor,
               BayesFactor,
               emmeans,
               progress,
               ggplot2,
               ggpubr,
               ggdist,
               ggsignif,
               visdat,
               ggthemr, 
               cowplot,
               patchwork,
               aplot,
               wesanderson,
               viridis,
               paletteer,
               ggdist,
               distributional,
               ggsci,
               grDevices,
               png,
               grid,
               gridGraphics,
               pander,
               formatR)
source(here("fun", "functions.R")) 
```


# Dataset

## Load

Load the raw data from eligible studies.

```{r, cache = FALSE}
# load
dat_raw <- suppressWarnings(read_xlsx(here("data", "data.xlsx"))) 
# rename the first column; somehow the original character is not correctly shown
names(dat_raw)[1] <- "Source"
```

## Preprocess

Necessary data pre-processes for the subsequent analyses:

- Calculate effect sizes using custom functions

- Flip effect sizes so that all effect sizes that are higher values can be interpreted as animals having higher level anxiety or depression-like behaviour

### Mean difference

```{r}
# calculate SD
if (any(is.na(dat_raw$CC_SD))) {
  dat_raw$CC_SD[is.na(dat_raw$CC_SD)] <- dat_raw$CC_SE[is.na(dat_raw$CC_SD)] * sqrt(dat_raw$CC_n[is.na(dat_raw$CC_SD)])
}

if (any(is.na(dat_raw$EC_SD))) {
  dat_raw$EC_SD[is.na(dat_raw$EC_SD)] <- dat_raw$EC_SE[is.na(dat_raw$EC_SD)] * sqrt(dat_raw$EC_n[is.na(dat_raw$EC_SD)])
}

if (any(is.na(dat_raw$CS_SD))) {
  dat_raw$CS_SD[is.na(dat_raw$CS_SD)] <- dat_raw$CS_SE[is.na(dat_raw$CS_SD)] * sqrt(dat_raw$CS_n[is.na(dat_raw$CS_SD)])
}

if (any(is.na(dat_raw$ES_SD))) {
  dat_raw$ES_SD[is.na(dat_raw$ES_SD)] <- dat_raw$ES_SE[is.na(dat_raw$ES_SD)] * sqrt(dat_raw$ES_n[is.na(dat_raw$ES_SD)])
}
# the first set
effect_size <- with(dat_raw, mapply(effect_set, 
                      CC_n,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      percent = Measurement_percent,
                      SIMPLIFY = FALSE
                      ))

effect_size <- map_dfr(effect_size, I)

# the second set
effect_size2 <- with(dat_raw, mapply(effect_set2, 
                      CC_n ,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      percent = Measurement_percent,
                      SIMPLIFY = FALSE))
effect_size2 <- map_dfr(effect_size2, I)

# without transformation of percent data for sensitivity analysis
effect_sizeb <- with(dat_raw, mapply(effect_setb, 
                      CC_n ,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      SIMPLIFY = FALSE))
effect_sizeb <- map_dfr(effect_sizeb, I)


# match
full_info <- which(complete.cases(effect_size) == TRUE & complete.cases(effect_size2) == TRUE & complete.cases(effect_size2) == TRUE)

# bind
dat <- bind_cols(dat_raw, effect_size, effect_size2, effect_sizeb)
dat <- dat[full_info, ]

# correcting effect sizes according to their biological direction
# focal ones - lnRR
dat$lnRR_Ea <- dat$lnRR_E * dat$Biological_direction
dat$lnRR_Sa <- dat$lnRR_S * dat$Biological_direction
dat$lnRR_ESa <- dat$lnRR_ES * dat$Biological_direction

# pure ones - lnRR
dat$lnRR_E2a <- dat$lnRR_E2 * dat$Biological_direction
dat$lnRR_S2a <- dat$lnRR_S2 * dat$Biological_direction
dat$lnRR_ES2a <- dat$lnRR_ES2 * dat$Biological_direction
dat$lnRR_E3a <- dat$lnRR_E3 * dat$Biological_direction
dat$lnRR_S3a <- dat$lnRR_S3 * dat$Biological_direction

# focal ones - SMD
dat$SMD_Ea <- dat$SMD_E * dat$Biological_direction
dat$SMD_Sa <- dat$SMD_S * dat$Biological_direction
dat$SMD_ESa <- dat$SMD_ES * dat$Biological_direction


# non-transformed ones
dat$lnRR_E_b <- dat$lnRR_Eb * dat$Biological_direction
dat$lnRR_S_b <- dat$lnRR_Sb * dat$Biological_direction
dat$lnRR_ES_b <- dat$lnRR_ESb * dat$Biological_direction
```

### Variance difference

```{r}
# get rid of proportion data
datV_raw <- dat_raw %>% filter(Measurement_percent != "Yes")

# the first set
effect_sizeV <- with(datV_raw, mapply(effect_setV, 
                      CC_n ,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      percent = "No",
                      SIMPLIFY = FALSE
                      ))

effect_sizeV <- map_dfr(effect_sizeV, I)

# the second set
#effect_size2 <- with(dat_raw, mapply(effect_set2, 
#                      CC_n ,
#                      CC_mean, 
#                      CC_SD,
#                      EC_n, 
#                      EC_mean, 
#                      EC_SD,
#                      CS_n, 
#                      CS_mean, 
#                      CS_SD,
#                      ES_n, 
#                      ES_mean, 
#                      ES_SD,
#                      percent = Measurement_percent,
#                      SIMPLIFY = FALSE))
#effect_size2 <- map_dfr(effect_size2, I)

# without transformation of percent data for sensitivity analysis
#effect_sizeb <- with(dat_raw, mapply(effect_setb, 
#                      CC_n ,
#                      CC_mean, 
#                      CC_SD,
#                      EC_n, 
#                      EC_mean, 
#                      EC_SD,
#                      CS_n, 
#                      CS_mean, 
#                      CS_SD,
#                      ES_n, 
#                      ES_mean, 
#                      ES_SD,
#                      SIMPLIFY = FALSE))
#effect_sizeb <- map_dfr(effect_sizeb, I)

# match
full_info <- which(complete.cases(effect_sizeV) == TRUE)

# bind
datV <- bind_cols(datV_raw, effect_sizeV)
datV <- datV[full_info, ]


```


### Sampling VCV matrix

Approximate within-study variance-covariance matrix to account for correlation between multiple observations.

```{r warning=FALSE}
# Mean effect sizes
# approximating VCV matrix for lnRR and SMD
VCV_E <- impute_covariance_matrix(vi = dat$lnRRV_E, cluster = dat$Study_ID, r = 0.5)
VCV_S <- impute_covariance_matrix(vi = dat$lnRRV_S, cluster = dat$Study_ID, r = 0.5)
VCV_ES <- impute_covariance_matrix(vi = dat$lnRRV_ES, cluster = dat$Study_ID, r = 0.5)

VCV_E_a <- impute_covariance_matrix(vi = dat$SMDV_E, cluster = dat$Study_ID, r = 0.5)
VCV_S_a <- impute_covariance_matrix(vi = dat$SMDV_S, cluster = dat$Study_ID, r = 0.5)
VCV_ES_a <- impute_covariance_matrix(vi = dat$SMDV_ES, cluster = dat$Study_ID, r = 0.5)

VCV_E_b <- impute_covariance_matrix(vi = dat$lnRRV_Eb, cluster = dat$Study_ID, r = 0.5)
VCV_S_b <- impute_covariance_matrix(vi = dat$lnRRV_Sb, cluster = dat$Study_ID, r = 0.5)
VCV_ES_b <- impute_covariance_matrix(vi = dat$lnRRV_ESb, cluster = dat$Study_ID, r = 0.5)

#write.csv

# Variance effect sizes
# approximating VCV matrix for lnVR and lnCVR
# lnVR
VCV_lnVR_E <- impute_covariance_matrix(vi = datV$lnVRV_E, cluster = datV$Study_ID, r = 0.5)
VCV_lnVR_S <- impute_covariance_matrix(vi = datV$lnVRV_S, cluster = datV$Study_ID, r = 0.5)
VCV_lnVR_ES <- impute_covariance_matrix(vi = datV$lnVRV_ES, cluster = datV$Study_ID, r = 0.5)

# lnCVR
VCV_lnCVR_E <- impute_covariance_matrix(vi = datV$lnCVRV_E, cluster = datV$Study_ID, r = 0.5)
VCV_lnCVR_S <- impute_covariance_matrix(vi = datV$lnCVRV_S, cluster = datV$Study_ID, r = 0.5)
VCV_lnCVR_ES <- impute_covariance_matrix(vi = datV$lnCVRV_ES, cluster = datV$Study_ID, r = 0.5)
```

# Study characteristics

```{r}
# n
df <- dat %>% group_by(Title) %>% mutate(Exp_N = length(unique(Exp_ID))) 
df <- distinct(df, Title, .keep_all = T)

# proportion
dat %>%
    group_by(Sex) %>%
    summarise(n = n()) %>%
    mutate(freq = n / sum(n))

dat %>%
    group_by(Study_ID) %>%
    summarise(n = n()) %>%
    mutate(freq = n / sum(n)) -> df



dat %>% 
  mutate(Study_ID_Pop_ID = paste(Study_ID, sep = "_", Pop_ID)) %>%
    group_by(Study_ID_Pop_ID) %>%
    summarise(n = n()) %>%
    mutate(freq = n / sum(n)) -> df

```


# 1. Average mean effect of mean

## Main

We meta-analytically aggregate LnRR to estimate the average mean effect of mean for enriched environment, stressed environments, and interaction between them.

The observational level effect size estimates are calculated from the following formulas (for the derivations, see the main text):

$$
\begin{aligned}
\ln{\text{RR}_\text{enrichment}} = 
\ln\left( \frac{ M_\text{ES} +  M_\text{EC}} {2} \right) - 
\ln\left( \frac {M_\text{CS} +  M_\text{CC}} {2} \right) = \ln \left(
{\frac {M_\text{ES} + M_\text{EC}} {M_\text{CS} + M_\text{CC}}}
 \right),
\end{aligned}
$$

Sampling variance was calculated as:

$$
\begin{aligned}
\text{var}(\ln{\text{RR}_\text{enrichment}}) = 
\left( 
\frac{1} { M_\text{ES} + M_\text{EC} } 
\right)^2
\left(
\frac{SD_\text{ES}^2}{N_\text{ES}} + \frac{SD_\text{EC}^2}{N_\text{EC}}
\right)& + \\\left( \frac {1} {  M_\text{CS} +  M_\text{CC} } \right)^2
\left(\frac{SD_\text{CS}^2}{N_\text{CS}} + \frac{SD_\text{CC}^2}{n_\text{CC}}
\right)&  
\end{aligned}
$$ 


$$
\ln{\text{RR}_\text{stress}} = 
\ln\left( \frac{ M_\text{ES} +  M_\text{CS}} {2} \right) - 
\ln\left( \frac {M_\text{EC} +  M_\text{CC}} {2} \right) = \ln \left(
{\frac {M_\text{ES} + M_\text{CS}} {M_\text{EC} + M_\text{CC}}} 
 \right),
$$

Sampling variance was calculated as:

$$
\begin{align*}
\text{var}(\ln{\text{RR}_\text{stress}}) = 
\left( 
\frac{1} { M_\text{ES} + M_\text{CS} } 
\right)^2
\left(
\frac{SD_\text{ES}^2}{N_\text{ES}} + \frac{SD_\text{CS}^2}{N_\text{CS}} 
\right) & + \\
\left( \frac {1} {  M_\text{EC} +  M_\text{CC} } \right)^2
\left(\frac{SD_\text{EC}^2}{N_\text{EC}} + \frac{SD_\text{CC}^2}{N_\text{CC}}
\right)
\end{align*}
$$



$$
\ln{\text{RR}_\text{interaction}} 
= \left(\ln M_\text{ES} -  \ln M_\text{CS}  \right) - 
\left( \ln M_\text{EC} -  \ln M_\text{CC} \right)
= 
\ln \left( \frac {M_\text{ES} / M_\text{CS} } 
{M_\text{EC} / \ M_\text{CC}} \right)
$$

Sampling variance was calculated as:

$$
\text{var}(\ln{\text{RR}_\text{interaction}}) =
\frac {SD_\text{ES}^2} { N_\text{ES} M_\text{ES}^2 } + \frac{SD_\text{EC}^2}{N_\text{EC}M_\text{EC}^2} + 
\frac {SD_\text{CS}^2}{N_\text{CS} M_\text{CS}^2} + \frac{SD_\text{CC}^2}{N_\text{CC} M_\text{CC}^2}.
$$


Formula alignment in R markdown: https://stackoverflow.com/questions/27081054/r-markdown-math-equation-alignment

The LnRR were meta-analytically fitted via:

```{r}
# null model for enrichment
mod_E0 <- run_null_mod(data = dat, V = VCV_E, yi = "lnRR_Ea")

# null model for stress
mod_S0 <- run_null_mod(data = dat, V = VCV_S, yi = "lnRR_Sa")

# null model for enrichment × stress
mod_ES0 <- run_null_mod(data = dat, V = VCV_ES, yi = "lnRR_ESa")
```


Then, we summarize the model results, calculate robust error, quantify the heterogeneity, and visualize results:

Enrichment:

```{r}
sum_model(
  model = mod_E0,
  model_label = c("Main effect of enriched environment on anxiety performance"),
  data = dat
)
```

Stress: 

```{r}
sum_model(
  model = mod_S0,
  model_label = c("Main effect of stress exposure on anxiety performance"),
  data = dat
)
```


Interaction:

```{r}
sum_model(
  model = mod_ES0,
  model_label = c("Enrichment × stress interaction on anxiety performance"),
  data = dat
)
```

## Alternative

We did two type of alternative analyses. Firstly, we re-ran all meta-analytic models using standardized mean difference (SMD) instead of lnRR. Secondly, we re-ran all meta-analytic models focusing on the un(arcsine)transformed percent data using lnRR.

### SMD

Enrichment:

```{r}
mod_E0_SMD <- rma.mv(yi = SMD_Ea, V = VCV_E_a, random = list(~1|Strain, ~1|Study_ID,
                                                         ~1|ES_ID),
                 test = "t",
                 data = dat)
summary(mod_E0_SMD)
robust(mod_E0_SMD, cluster = Study_ID, adjust = T)
i2_ml(mod_E0_SMD)
orchard_plot(mod_E0_SMD, 
             mod = "1", 
             xlab = "Effect size SMD", 
             group = "Strain",  k = TRUE, g = TRUE, trunk.size = 1.5, 
             data = dat) + 
             scale_x_discrete(labels = c("Main effect of enriched environment on anxiety performance")) 

```

Stress:

```{r, message = FALSE, warning = FALSE}
mod_S0a <- rma.mv(yi = SMD_Sa, V = VCV_S_a, random = list(~1|Strain, ~1|Study_ID,
                                                         ~1|ES_ID),
                test = "t",
                data = dat)
summary(mod_S0a) 
robust(mod_S0a, cluster = Study_ID, adjust = T)
i2_ml(mod_S0a) 

orchard_plot(mod_S0a, 
             mod = "1", 
             xlab = "Effect size SMD", 
             group = "Study_ID",  k = TRUE, g = TRUE, trunk.size = 1.5, 
             data = dat) + 
             scale_x_discrete(labels = c("Main effect of stress on anxiety performance")) 

```


Interaction:

```{r, message = FALSE, warning = FALSE}
mod_ES0a <- rma.mv(yi = SMD_ESa, V = VCV_ES_a, random = list(~1|Strain, ~1|Study_ID,
                                                            ~1|ES_ID),
                  test = "t",
                  dfs = "contain",
                  data = dat)
summary(mod_ES0a)
robust(mod_ES0a, cluster = Study_ID, adjust = T)
i2_ml(mod_ES0a) 

orchard_plot(mod_ES0a, 
             mod = "1", 
             xlab = "Effect size SMD", 
             group = "Study_ID",  k = TRUE, g = TRUE, trunk.size = 1.5, 
             data = dat) + 
             scale_x_discrete(labels = c("Interactive effect of enrichment and stress on anxiety performance")) 
```


### Untransformed percent data

Enrichment:

```{r}
mod_E0b <- rma.mv(yi = lnRR_E_b, V = VCV_E_b, 
                  random = list(~1|Strain, ~1|Study_ID,
                                ~1|ES_ID),
                 test = "t",
                 dfs = "contain",
                 data = dat)
summary(mod_E0b)
robust(mod_E0b, cluster = Study_ID, adjust = T)
i2_ml(mod_E0b)
orchard_plot(mod_E0b, 
             mod = "1", 
             xlab = "Effect size lnRR", 
             group = "Strain",  k = TRUE, g = TRUE, trunk.size = 1.5, 
             data = dat) + 
             scale_x_discrete(labels = c("Main effect of enriched environment on anxiety performance")) 

```

Stress:

```{r}
mod_S0b <- rma.mv(yi = lnRR_S_b, V = VCV_S_b, random = list(~1|Strain, ~1|Study_ID,
                                                         ~1|ES_ID),
                 test = "t",
                 dfs = "contain",
                 data = dat)
summary(mod_S0b)
robust(mod_S0b, cluster = Study_ID, adjust = T)
i2_ml(mod_S0b)

orchard_plot(mod_S0b, 
             mod = "1", 
             xlab = "Effect size lnRR", 
             group = "Study_ID",  k = TRUE, g = TRUE, trunk.size = 1.5, 
             data = dat) + 
             scale_x_discrete(labels = c("Main effect of stress on anxiety performance")) 
```

Interaction:

```{r}
mod_ES0b <- rma.mv(yi = lnRR_ES_b, V = VCV_ES_b, random = list(~1|Strain, ~1|Study_ID,
                                                         ~1|ES_ID),
                 test = "t",
                 dfs = "contain",
                 data = dat)
summary(mod_ES0b)
robust(mod_ES0b, cluster = Study_ID, adjust = T)
i2_ml(mod_ES0b)

orchard_plot(mod_ES0b, 
             mod = "1", 
             xlab = "Effect size lnRR", 
             group = "Study_ID",  k = TRUE, g = TRUE, trunk.size = 1.5, 
             data = dat) + 
             scale_x_discrete(labels = c("Interactive effect of enrichment and stress on anxiety performance")) 
```


# 2. Average mean effect of variance

## mean-sd relationship

Examine mean-variance relationship to choose which type of variance effect size measures should be used. Given that variance is strongly correlated with mean, so lnCVR is preferable to account for the indirect impact of mean on variance effect. 

The Pearson correlation coefficients for CC, EC, CS, and ES groups:

```{r}
cor.test(log(datV$CC_mean), log(datV$CC_SD))$estimate # 0.9181422 
cor.test(log(datV$EC_mean), log(datV$EC_SD))$estimate # 0.9149036
cor.test(log(datV$CS_mean), log(datV$CS_SD))$estimate # 0.90085
cor.test(log(datV$ES_mean), log(datV$ES_SD))$estimate # 0.9142002
```


We meta-analytically aggregate LnCVR to estimate the average mean effect of mean for enriched environment, stressed environments, and interaction between them.

The observational level effect size estimates are calculated from the following formulas (for the derivations, see the main text):

Enriched environment:

$$
\begin{align*}
\ln{\text{CVR}_\text{enrichment}}  = & \frac{1}{2} \ln\left( \frac{ CV_\text{ES} CV_\text{EC}} {CV_\text{CS} CV_\text{CC}} \right) + \\  & \frac{1}{2} \left[\frac{1}{2\left( N_\text{ES}-1 \right)} + \frac{1}{2\left( N_\text{EC}-1 \right)} - \frac{1}{2\left( N_\text{CS}-1 \right)} - \frac{1}{2\left( N_\text{CC}-1 \right)} \right],
\end{align*}
$$

Variance was calculated as:

$$
\text{var}(\ln{\text{CVR}_\text{enrichment}}) = \text{var}(\ln{\text{RR}_\text{enrichment}}) + \text{var}(\ln{\text{VR}_\text{enrichment}})
$$ 

Stressed environment:

$$
\begin{align*}
\ln{\text{CVR}_\text{stress}}  = & \frac{1}{2} \ln\left( \frac{ CV_\text{ES} CV_\text{ES}} {CV_\text{CS} CV_\text{CC}} \right) + \\  & \frac{1}{2} \left[\frac{1}{2\left( N_\text{ES}-1 \right)} + \frac{1}{2\left( N_\text{EC}-1 \right)} - \frac{1}{2\left( N_\text{CS}-1 \right)} - \frac{1}{2\left( N_\text{CC}-1 \right)} \right],
\end{align*}
$$

Variance was calculated as:

$$
\text{var}(\ln{\text{CVR}_\text{stress}}) = \text{var}(\ln{\text{RR}_\text{stress}}) + \text{var}(\ln{\text{VR}_\text{stress}})
$$ 

Interaction between enrichment x stress:

$$
\begin{align*}
\ln{\text{CVR}_\text{interaction}} = & \text{ln}\left( \frac{ CV_\text{ES} /CV_\text{CS}} {CV_\text{CS}/CV_\text{CC}} \right) + \\  & \frac{1}{2\left( N_\text{ES}-1 \right)} - \frac{1}{2\left( N_\text{EC}-1 \right)} - \frac{1}{2\left( N_\text{CS}-1 \right)} + \frac{1}{2\left( N_\text{CC}-1 \right)} ,
\end{align*}
$$

Variance was calculated as:

$$
\text{var}(\ln{\text{CVR}_\text{interaction}}) = \text{var}(\ln{\text{RR}_\text{interaction}}) + \text{var}(\ln{\text{VR}_\text{interaction}})
$$ 



The LnCVR were meta-analytically fitted via:

```{r}
# enrichment
mod_lnCVR_E0 <- run_null_mod(data = datV, V = VCV_lnCVR_E, yi = "lnCVR_E")

#  stress
mod_lnCVR_S0 <- run_null_mod(data = datV, V = VCV_lnCVR_S, yi = "lnCVR_S")

# enrichment × stress
mod_lnCVR_ES0 <- run_null_mod(data = datV, V = VCV_lnCVR_ES, yi = "lnCVR_ES")
```


Like we did in mean part, we again summarize the model results:

Enrichment:

```{r}
sum_model(
  model = mod_lnCVR_E0,
  model_label = c("Main effect of enriched environment on anxiety stability"),
  data = datV
)
```

Stress: 

```{r}
sum_model(
  model = mod_lnCVR_S0,
  model_label = c("Main effect of stress exposure on anxiety stability"),
  data = datV
)
```


Interaction:

```{r}
sum_model(
  model = mod_lnCVR_ES0,
  model_label = c("Enrichment × stress interaction on anxiety stability"),
  data = datV
)
```


# 3. Moderator analysis on mean

We have tested the following pre-defined moderator variables:

- `Sex`

- `Window_EE_exposure`

- `Window_stress_exposure`

- `EE_physical`

- `EE_social`

- `Stress_biotic` 

- `Stress_abiotic`

- `Outcome_category`

Using the above variables to account for (potential) heterogeneity among effect sizes:

```{r}
# check any coding errors
table(dat$Sex)
table(dat$Window_EE_exposure)
table(dat$Window_stress_exposure)
table(dat$EE_physical)
table(dat$EE_social)
table(dat$Stress_biotic)
table(dat$Stress_abiotic)
table(dat$Outcome_category)


# moderator variables for each model type
mod_vars_E  <- c("Sex", "Window_EE_exposure", "EE_physical", "EE_social", "Outcome_category")
mod_vars_S  <- c("Sex", "Window_stress_exposure", "Stress_biotic", "Stress_abiotic", "Outcome_category")
mod_vars_ES <- c("Sex", "Window_EE_exposure", "Window_stress_exposure", 
                 "EE_physical", "EE_social", "Stress_biotic", "Stress_abiotic", "Outcome_category")


# enrichment
mod_E <- lapply(mod_vars_E, function(v) run_mod(v, dat, VCV_E, "lnRR_Ea"))
names(mod_E) <- paste0("mod_E", seq_along(mod_vars_E))

# stress
mod_S <- lapply(mod_vars_S, function(v) run_mod(v, dat, VCV_S, "lnRR_Sa"))
names(mod_S) <- paste0("mod_S", seq_along(mod_vars_S))

# enrichment × stress
mod_ES <- lapply(mod_vars_ES, function(v) run_mod(v, dat, VCV_ES, "lnRR_ESa"))
names(mod_ES) <- paste0("mod_ES", seq_along(mod_vars_ES))
```

# 4. Moderator analysis on variance

Account for (potential) heterogeneity among variance:

```{r}
# enrichment
mod_lnCVR_E <- lapply(mod_vars_E, function(v) run_mod(v, datV, VCV_lnCVR_E, "lnCVR_E"))
names(mod_lnCVR_E) <- paste0("mod_lnCVR_E", seq_along(mod_vars_E))

# stress
mod_lnCVR_S <- lapply(mod_vars_S, function(v) run_mod(v, datV, VCV_lnCVR_S, "lnCVR_S"))
names(mod_lnCVR_S) <- paste0("mod_lnCVR_S", seq_along(mod_vars_S))

# enrichment × stress
mod_lnCVR_ES <- lapply(mod_vars_ES, function(v) run_mod(v, datV, VCV_lnCVR_ES, "lnCVR_ES"))
names(mod_lnCVR_ES) <- paste0("mod_lnCVR_ES", seq_along(mod_vars_ES))
```


# Sensitivity analyses

## Model selection

Use the multi-moderator meta-regression to check the robustness：

```{r}
res_enrichment <- run_model_selection_pipeline(
  yi_name = "lnRR_Ea",
  V_matrix = VCV_E,
  fixed_effects = "~ Sex + Window_EE_exposure + EE_physical + EE_social + Outcome_category",
  dat = dat,
  model_rds_path = "data/MLMR.full_enrichment.Rds",
  dredge_rds_path = "data/MLMR.candidate_enrichment.Rds",
  best_models_rds_path = "data/MLMR.best_enrichment.Rds",
  label = "enrichment"
)
res_enrichment
#saveRDS(res_enrichment, here("data", "res_enrichment.Rds"))
res_enrichment <- readRDS(here("data", "res_enrichment.Rds"))
```

Alternative way to do model section and model average:

```{r}
# model selection
MLMR.candidate4 <- glmulti(
  lnRR_Ea ~ Sex + Window_EE_exposure + EE_physical + EE_social + Outcome_category,
  data = dat,
  level = 1,
  marginality = FALSE,
  fitfunction = custom_rma_mv,
  crit = "aicc",
  confsetsize = 256,
  plotty = FALSE,
  report = TRUE
)

# saveRDS(MLMR.candidate4, here("data", "MLMR.candidate4.Rds"))
MLMR.candidate4 <- readRDS(here("data", "MLMR.candidate4.Rds"))
res <- analyze_mlmr_models(MLMR.candidate4)
```

## MRP

```{r}
data <- dat
strain_results <- post_strat_analysis("Strain", data, VCV_E)
sex_results <- post_strat_analysis("Sex", data, VCV_E)
results <- rbind(strain_results, sex_results)
results
```



## Publication bias {.tabset}

### Visual check of publication bias

Residual funnel plots:

```{r}
# check the best models
# MLMR.best[MLMR.best$aicc <= min(MLMR.best$aicc) + 2, ] %>% DT::datatable()

# residual funnel plot 1
funnel1 <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), mods = ~ 1 + Window_EE_exposure, test = "t", data = dat, sparse = T)

# residual funnel plot 2
# check important predictors MLMR.candidate4@objects[[1]] %>% formula()
funnel2 <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), mods = ~ 1 + Window_EE_exposure + EE_social, test = "t", data = dat, sparse = T)
```


### Statistical test of publicaiton bias

Simultaneously test small-study effect and time lag bias:

```{r}
dat <- dat %>% mutate(Year_pub.c = scale(Year_pub,scale=F),
                      lnRRse_E = sqrt(lnRRV_E))
# check important predictors MLMR.candidate4@objects[[1]] %>% formula()
pb_lnRR <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), mods = ~ 1 + lnRRse_E + Year_pub.c + Window_EE_exposure, test = "t", data = dat, sparse = T)
summary(pb_lnRR)

```

### Publicaiton bias correction

Use the double robust method to correct for publication bias:

```{r}
#W <- solve(VCV_E)
pbc_lnRR <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), test = "t", data = dat, sparse = T)
pbc_lnRR1 <- rma.mv(yi = lnRR_Ea, V = VCV_E, test = "t", data = dat)
pbc_lnRR2 <- robust(pbc_lnRR1, cluster = dat$Study_ID)
```

## Leave-one-out cross-validation

```{r}
data <- dat
results <- leave_one_out_analysis(data, moderator = "Strain")
#saveRDS(results, here("data", "leave1out_mod.Rds"))
leave1out_results <- readRDS(here("data", "leave1out_mod.Rds"))
```
 
## Risk of bias

ROB blinding, and randomisation:

```{r, warning=F}
ROB_lnRR1 <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), test = "t", data = dat, sparse = T, subset = ROB_blinding =="Yes")
ROB_lnRR2 <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), test = "t", data = dat, sparse = T, subset = ROB_randomisation=="Yes")

ROB_lnCVR1 <- rma.mv(yi = lnCVR_E, V = VCV_lnCVR_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), test = "t", data = datV, sparse = T, subset = ROB_blinding =="Yes")

ROB_lnCVR2 <- rma.mv(yi = lnCVR_E, V = VCV_lnCVR_E, random = list(~1|Strain, ~1|Study_ID, ~1|ES_ID), test = "t", data = datV, sparse = T, subset = ROB_randomisation=="Yes")
```

# Main plots

## Fig. 2

```{r, warning=FALSE,message=FALSE}
results <- prepare_mod_results(
  mod_E0 = mod_E0,
  mod_S0 = mod_S0,
  mod_ES0 = mod_ES0,
  data = dat,
  vi_E = "lnRRV_E",  
  vi_S = "lnRRV_S", 
  vi_ES = "lnRRV_ES",  
  group = "Strain"  
)

p <- plot_base_mod_results(
  results = results,
  cbpl = c("#E69F00", "#56B4E9", "#009E73")
)

group_no <- length(results$mod_table$name)
results$mod_table$g <- as.numeric(results$mod_table$g$n)
p <- p +
  annotate(
    "text",
    y = (0 + (max(results$data$yi) * 0.30)),
    x = (seq(1, group_no, 1) + 0.5),
    label = paste("italic(N)[observation]==", results$mod_table$K[1:group_no]),
    parse = TRUE, hjust = "right", size = 3
  ) +
  annotate(
    "text",
    y = (0 + (max(results$data$yi) * 0.30)),
    x = (seq(1, group_no, 1) + 0.3),
    label = paste("italic(N)['rodent strain']==", ifelse(is.na(results$mod_table$g[1:group_no]), "NA", results$mod_table$g[1:group_no])),
    parse = TRUE, hjust = "right", size = 3
  ) +
  scale_y_continuous(limits = c(-1.6, 1.1), expand = c(0, 0)) +
  labs(
    y = bquote("Expression of depression or anxiety" * " (" * italic(beta)[LnRR] * ")"),
    x = "",
    size = latex2exp::TeX("Uncertainty")
  ) +
  scale_x_discrete(labels = stringr::str_wrap(c("Stressed-Enriched interaction", "Stressed environment", "Enriched environment"), width = 0.5))

png(filename = "Fig. 2.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
p
dev.off()
```


## Fig. 3

```{r}
results_lncvr <- prepare_mod_results_lncvr(
  mod_lnCVR_E0 = mod_lnCVR_E0,
  mod_lnCVR_S0 = mod_lnCVR_S0,
  mod_lnCVR_ES0 = mod_lnCVR_ES0,
  data = datV,
  vi_E = "lnCVRV_E",
  vi_S = "lnCVRV_S",
  vi_ES = "lnCVRV_ES",
  group = "Strain"
)

p <- plot_base_mod_results_lncvr(
  results = results_lncvr,
  cbpl = c("#E69F00", "#56B4E9", "#009E73")
)

group_no <- length(results_lncvr$mod_table$name)
results_lncvr$mod_table$g <- as.numeric(results_lncvr$mod_table$g$n)
p <- p +
  annotate(
    "text",
    y = (0 + (max(results_lncvr$data$yi) * 0.60)),
    x = (seq(1, group_no, 1) + 0.5),
    label = paste("italic(N)[observation]==", results_lncvr$mod_table$K[1:group_no]),
    parse = TRUE, hjust = "right", size = 3
  ) +
  annotate(
    "text",
    y = (0 + (max(results_lncvr$data$yi) * 0.60)),
    x = (seq(1, group_no, 1) + 0.3),
    label = paste("italic(N)['rodent strain']==", ifelse(is.na(results_lncvr$mod_table$g[1:group_no]), "NA", results_lncvr$mod_table$g[1:group_no])),
    parse = TRUE, hjust = "right", size = 3
  ) +
  scale_y_continuous(limits = c(-2.1, 2.1), expand = c(0, 0)) +
  labs(
    y = bquote("Inter-individual difference in depression or anxiety" * " (" * italic(beta)[LnCVR] * ")"),
    x = "",
    size = latex2exp::TeX("Uncertainty")
  ) +
  scale_x_discrete(labels = stringr::str_wrap(c("Stressed-Enriched interaction", "Stressed environment", "Enriched environment"), width = 0.5))


      annotate('text', y = (0 + (max(data_trim$yi)*0.60)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      annotate('text', y = (0 + (max(data_trim$yi)*0.60)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-2.1, 2.1), expand = c(0,0)) +
      labs(y = bquote("Inter-individual difference in depression or anxiety"  * " (" * italic(beta)[LnCVR] * ")"), x = "", size = latex2exp::TeX(legend)) +
  scale_x_discrete(labels = stringr::str_wrap(c("Stressed-Enriched interaction", "Stressed environment", "Enriched environment"), width = 0.5)) -> p

png(filename = "Fig. 3.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
p
dev.off()

```

## Mean-based moderator analysis

### Enrichment

```{r}
# plot
## prepare data
### Sex
mod_E1_results <- run_mod_results(
  model = mod_E$mod_E1,
  mod = "Sex",
  data = mod_E$mod_E1$data
)


### Window_EE_exposure
mod_E2_results <- run_mod_results(
  model = mod_E$mod_E2,
  mod = "Window_EE_exposure",
  data = mod_E$mod_E2$data
)
  
### EE_physical
mod_E3_results <- run_mod_results(
  model = mod_E$mod_E3,
  mod = "EE_physical",
  data = mod_E$mod_E3$data
)
 
### EE_social
mod_E4_results <- run_mod_results(
  model = mod_E$mod_E4,
  mod = "EE_social",
  data = mod_E$mod_E4$data
)

  
### Outcome_category
mod_E5_results <- run_mod_results(
  model = mod_E$mod_E5,
  mod = "Outcome_category",
  data = mod_E$mod_E5$data
)


# plot
## Sex
mod_E1_results$mod_table$name <- factor(mod_E1_results$mod_table$name, levels = c("Mixed", "Male", "Female"))
results <- prepare_mod_data(mod_E1_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#ADD8E6") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Sex of animal", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p1_EE_lnRR


## Window_EE_exposure
mod_E2_results$mod_table$name <- factor(mod_E2_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_E2_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#EEDD82") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = "", title = "Exposure window", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
        theme(#axis.text.y = element_text(size = 8),
              axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p2_EE_lnRR


## EE_physical
mod_E3_results$mod_table$name <- factor(mod_E3_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_E3_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#FFB6C1") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = "", title = "Physical enrichment?", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p3_EE_lnRR

# EE_social
mod_E4_results$mod_table$name <- factor(mod_E4_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_E4_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#CAFF70") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Social enrichment?", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE"))-> p4_EE_lnRR

# Outcome_category
mod_E5_results$mod_table$name <- factor(mod_E5_results$mod_table$name, levels = c("Anxiety", "Depression"))
results <- prepare_mod_data(mod_E5_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#FFE4E1") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Outcome category", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p5_EE_lnRR



# combine the plots
p <- ((p1_EE_lnRR + p2_EE_lnRR) /
     (p3_EE_lnRR + p4_EE_lnRR) /
     (p5_EE_lnRR + plot_spacer()))  +  # plot_spacer adds empty space to fill 2nd cell
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D", "E"))  & 
  theme(
      plot.tag = element_text(size = 14, face = "bold") 
    )
```


### Stress
```{r}
# plot
## prepare data
### Sex
mod_S1_results <- run_mod_results(
  model = mod_S$mod_S1,
  mod = "Sex",
  data = mod_S$mod_S1$data
)

### Window_stress_exposure
mod_S2_results <- run_mod_results(
  model = mod_S$mod_S2,
  mod = "Window_stress_exposure",
  data = mod_S$mod_S2$data
)
  
### Stress_biotic
mod_S3_results <- run_mod_results(
  model = mod_S$mod_S3,
  mod = "Stress_biotic",
  data = mod_S$mod_S3$data
)

### Stress_abiotic
mod_S4_results <- run_mod_results(
  model = mod_S$mod_S4,
  mod = "Stress_abiotic",
  data = mod_S$mod_S4$data
)

### Outcome_category
mod_S5_results <- run_mod_results(
  model = mod_S$mod_S5,
  mod = "Outcome_category",
  data = mod_S$mod_S5$data
)
  
# plot
## Sex
mod_S1_results$mod_table$name <- factor(mod_S1_results$mod_table$name, levels = c("Mixed", "Male", "Female"))
results <- prepare_mod_data(mod_S1_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#ADD8E6") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Sex of animal", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p1_SE_lnRR



## Window_stress_exposure
mod_S2_results$mod_table$name <- factor(mod_S2_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_S2_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#EEDD82") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = "", title = "Exposure window", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p2_SE_lnRR


## Stress_biotic
mod_S3_results$mod_table$name <- factor(mod_S3_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_S3_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#FFB6C1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = "", title = "Biotic stress?", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p3_SE_lnRR

# Stress_abiotic
mod_S4_results$mod_table$name <- factor(mod_S4_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_S4_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#CAFF70") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Abiotic stress?", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE"))-> p4_SE_lnRR

# Outcome_category
mod_S5_results$mod_table$name <- factor(mod_S5_results$mod_table$name, levels = c("Anxiety", "Depression"))
results <- prepare_mod_data(mod_S5_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#FFE4E1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.4)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Outcome category", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p5_SE_lnRR



# combine the plots
p <- ((p1_SE_lnRR + p2_SE_lnRR) /
     (p3_SE_lnRR + p4_SE_lnRR) /
     (p5_SE_lnRR + plot_spacer()))  +  
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D", "E"))  & 
  theme(
      plot.tag = element_text(size = 14, face = "bold") 
    )

```

### Interaction

```{r}
# plot
## prepare data
### Sex
mod_ES1_results <- run_mod_results(
  model = mod_ES$mod_ES1,
  mod = "Sex",
  data = mod_ES$mod_ES1$data
)
  
### Window_EE_exposure
mod_ES2_results <- run_mod_results(
  model = mod_ES$mod_ES2,
  mod = "Window_EE_exposure",
  data = mod_ES$mod_ES2$data
)
  
 
### Window_stress_exposure
mod_ES3_results <- run_mod_results(
  model = mod_ES$mod_ES3,
  mod = "Window_stress_exposure",
  data = mod_ES$mod_ES3$data
)

### EE_physical
mod_ES4_results <- run_mod_results(
  model = mod_ES$mod_ES4,
  mod = "EE_physical",
  data = mod_ES$mod_ES4$data
)


### EE_social
mod_ES5_results <- run_mod_results(
  model = mod_ES$mod_ES5,
  mod = "EE_social",
  data = mod_ES$mod_ES5$data
)


### Stress_biotic
mod_ES6_results <- run_mod_results(
  model = mod_ES$mod_ES6,
  mod = "Stress_biotic",
  data = mod_ES$mod_ES6$data
)
  
### Stress_abiotic
mod_ES7_results <- run_mod_results(
  model = mod_ES$mod_ES7,
  mod = "Stress_abiotic",
  data = mod_ES$mod_ES7$data
)

### Outcome_category
mod_ES8_results <- run_mod_results(
  model = mod_ES$mod_ES8,
  mod = "Outcome_category",
  data = mod_ES$mod_ES8$data
)
  

# plot
## Sex
mod_ES1_results$mod_table$name <- factor(mod_ES1_results$mod_table$name, levels = c("Mixed", "Female", "Male"))
results <- prepare_mod_data(mod_ES1_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#ADD8E6") +
        add_my_layers(mod_table = mod_table, cbpl = cbpl) +
        annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Sex of animal", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p1_ES_lnRR

## Outcome_category
mod_ES8_results$mod_table$name <- factor(mod_ES8_results$mod_table$name, levels = c("Anxiety", "Depression"))
results <- prepare_mod_data(mod_ES8_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#FFE4E1") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Outcome category", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p8_ES_lnRR


## Window_EE_exposure
mod_ES2_results$mod_table$name <- factor(mod_ES2_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_ES2_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#EEDD82") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Exposure window of enrichment", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p2_ES_lnRR


## Window_stress_exposure
mod_ES3_results$mod_table$name <- factor(mod_ES3_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_ES3_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#98FB98") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Exposure window of stress", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p3_ES_lnRR



# combine
# combine the plots
p <- ((p8_ES_lnRR + p1_ES_lnRR) /
     (p2_ES_lnRR + p3_ES_lnRR))  +
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D"))  & 
  theme(
      plot.tag = element_text(size = 14, face = "bold") 
    )


## EE_physical
mod_ES4_results$mod_table$name <- factor(mod_ES4_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_ES4_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#CDB7B5") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Physical enrichment?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p4_ES_lnRR

## EE_social
mod_ES5_results$mod_table$name <- factor(mod_ES5_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_ES5_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#9AC0CD") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Social enrichment?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p5_ES_lnRR

## Stress_biotic
mod_ES6_results$mod_table$name <- factor(mod_ES6_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_ES6_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#CDBE70") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Biotic stress?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p6_ES_lnRR


## Stress_abiotic
mod_ES7_results$mod_table$name <- factor(mod_ES7_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_ES7_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#7CCD7C") +
      add_my_layers(mod_table = mod_table, cbpl = cbpl) +
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
      annotate('text', y = (0 + (max(components$data_trim$yi)*0.35)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
      scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
      labs(y = bquote("Expression of depression or anxiety"  * " (" * italic(beta)[LnRR] * ")"), x = " ", title = "Abiotic stress?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
        theme(axis.title = element_text(size = 12),
              plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p7_ES_lnRR




# combine
# combine the plots
p <- ((p4_ES_lnRR + p5_ES_lnRR) /
     (p6_ES_lnRR + p7_ES_lnRR))  +
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D"))  & 
  theme(
      plot.tag = element_text(size = 14, face = "bold") 
    )
```


## Variance-based moderator analysis

### Enrichment

```{r}
# plot
## prepare data
### Sex
mod_lnCVR_E1_results <- run_mod_results(
  model = mod_lnCVR_E$mod_lnCVR_E1,
  mod = "Sex",
  data = mod_lnCVR_E$mod_lnCVR_E1$data
)

### Window_EE_exposure
mod_lnCVR_E2_results <- run_mod_results(
  model = mod_lnCVR_E$mod_lnCVR_E2,
  mod = "Window_EE_exposure",
  data = mod_lnCVR_E$mod_lnCVR_E2$data
)

### EE_physical
mod_lnCVR_E3_results <- run_mod_results(
  model = mod_lnCVR_E$mod_lnCVR_E3,
  mod = "EE_physical",
  data = mod_lnCVR_E$mod_lnCVR_E3$data
)

### EE_social
mod_lnCVR_E4_results <- run_mod_results(
  model = mod_lnCVR_E$mod_lnCVR_E4,
  mod = "EE_social",
  data = mod_lnCVR_E$mod_lnCVR_E4$data
)


### Outcome_category
mod_lnCVR_E5_results <- run_mod_results(
  model = mod_lnCVR_E$mod_lnCVR_E5,
  mod = "Outcome_category",
  data = mod_lnCVR_E$mod_lnCVR_E5$data
)


# plot
## Sex
mod_lnCVR_E1_results$mod_table$name <- factor(mod_lnCVR_E1_results$mod_table$name, levels = c("Mixed", "Male", "Female"))
results <- prepare_mod_data(mod_lnCVR_E1_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#ADD8E6") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-2.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Sex of animal", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p1_EE_lnCVR



## Window_EE_exposure
mod_lnCVR_E2_results$mod_table$name <- factor(mod_lnCVR_E2_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_lnCVR_E2_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#EEDD82") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-2.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = "", title = "Exposure window", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p2_EE_lnCVR


## EE_physical
mod_lnCVR_E3_results$mod_table$name <- factor(mod_lnCVR_E3_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_E3_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#FFB6C1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-2.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = "", title = "Physical enrichment?", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p3_EE_lnCVR

# EE_social
mod_lnCVR_E4_results$mod_table$name <- factor(mod_lnCVR_E4_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_E4_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#CAFF70") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-2.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Social enrichment?", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE"))-> p4_EE_lnCVR

# Outcome_category
mod_lnCVR_E5_results$mod_table$name <- factor(mod_lnCVR_E5_results$mod_table$name, levels = c("Anxiety", "Depression"))
results <- prepare_mod_data(mod_lnCVR_E5_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)

plot_base_quasirandom(components$data_trim, fill_color = "#FFE4E1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-2.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Outcome category", subtitle = "Enriched environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p5_EE_lnCVR



# combine the plots
p <- ((p1_EE_lnCVR + p2_EE_lnCVR) /
        (p3_EE_lnCVR + p4_EE_lnCVR) /
        (p5_EE_lnCVR + plot_spacer()))  + 
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D", "E"))  & 
  theme(
    plot.tag = element_text(size = 14, face = "bold") 
  )
```


### Stress

```{r}
# plot
## prepare data
### Sex
mod_lnCVR_S1_results <- run_mod_results(
  model = mod_lnCVR_S$mod_lnCVR_S1,
  mod = "Sex",
  data = mod_lnCVR_S$mod_lnCVR_S1$data
)

### Window_stress_exposure
mod_lnCVR_S2_results <- run_mod_results(
  model = mod_lnCVR_S$mod_lnCVR_S2,
  mod = "Window_stress_exposure",
  data = mod_lnCVR_S$mod_lnCVR_S2$data
)

### Stress_biotic
mod_lnCVR_S3_results <- run_mod_results(
  model = mod_lnCVR_S$mod_lnCVR_S3,
  mod = "Stress_biotic",
  data = mod_lnCVR_S$mod_lnCVR_S3$data
)

### Stress_abiotic
mod_lnCVR_S4_results <- run_mod_results(
  model = mod_lnCVR_S$mod_lnCVR_S4,
  mod = "Stress_abiotic",
  data = mod_lnCVR_S$mod_lnCVR_S4$data
)

### Outcome_category
mod_lnCVR_S5_results <- run_mod_results(
  model = mod_lnCVR_S$mod_lnCVR_S5,
  mod = "Outcome_category",
  data = mod_lnCVR_S$mod_lnCVR_S5$data
)


# plot
## Sex
mod_lnCVR_S1_results$mod_table$name <- factor(mod_lnCVR_S1_results$mod_table$name, levels = c("Mixed", "Male", "Female"))
results <- prepare_mod_data(mod_lnCVR_S1_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#ADD8E6") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Sex of animal", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p1_SE_lnCVR



## Window_stress_exposure
mod_lnCVR_S2_results$mod_table$name <- factor(mod_lnCVR_S2_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_lnCVR_S2_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#EEDD82") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = "", title = "Exposure window", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p2_SE_lnCVR


## Stress_biotic
mod_lnCVR_S3_results$mod_table$name <- factor(mod_lnCVR_S3_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_S3_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#FFB6C1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = "", title = "Biotic stress?", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p3_SE_lnCVR

# Stress_abiotic
mod_lnCVR_S4_results$mod_table$name <- factor(mod_lnCVR_S4_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_S4_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#CAFF70") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Abiotic stress?", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE"))-> p4_SE_lnCVR

# Outcome_category
mod_lnCVR_S5_results$mod_table$name <- factor(mod_lnCVR_S5_results$mod_table$name, levels = c("Anxiety", "Depression"))
results <- prepare_mod_data(mod_lnCVR_S5_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#FFE4E1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.9)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.1), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Outcome category", subtitle = "Stressed environment", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p5_SE_lnCVR



# combine the plots
p <- ((p1_SE_lnCVR + p2_SE_lnCVR) /
        (p3_SE_lnCVR + p4_SE_lnCVR) /
        (p5_SE_lnCVR + plot_spacer()))  + 
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D", "E"))  & 
  theme(
    plot.tag = element_text(size = 14, face = "bold") 
  )
```

### Interaction

```{r}
# plot
## prepare data
### Sex
mod_lnCVR_ES1_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES1,
  mod = "Sex",
  data = mod_lnCVR_ES$mod_lnCVR_ES1$data
)

### Window_EE_exposure
mod_lnCVR_ES2_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES2,
  mod = "Window_EE_exposure",
  data = mod_lnCVR_ES$mod_lnCVR_ES2$data
)


### Window_stress_exposure
mod_lnCVR_ES3_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES3,
  mod = "Window_stress_exposure",
  data = mod_lnCVR_ES$mod_lnCVR_ES3$data
)

### EE_physical
mod_lnCVR_ES4_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES4,
  mod = "EE_physical",
  data = mod_lnCVR_ES$mod_lnCVR_ES4$data
)


### EE_social
mod_lnCVR_ES5_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES5,
  mod = "EE_social",
  data = mod_lnCVR_ES$mod_lnCVR_ES5$data
)


### Stress_biotic
mod_lnCVR_ES6_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES6,
  mod = "Stress_biotic",
  data = mod_lnCVR_ES$mod_lnCVR_ES6$data
)

### Stress_abiotic
mod_lnCVR_ES7_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES7,
  mod = "Stress_abiotic",
  data = mod_lnCVR_ES$mod_lnCVR_ES7$data
)

### Outcome_category
mod_lnCVR_ES8_results <- run_mod_results(
  model = mod_lnCVR_ES$mod_lnCVR_ES8,
  mod = "Outcome_category",
  data = mod_lnCVR_ES$mod_lnCVR_ES8$data
)



# plot
## Sex
mod_lnCVR_ES1_results$mod_table$name <- factor(mod_lnCVR_ES1_results$mod_table$name, levels = c("Mixed", "Male", "Female"))
results <- prepare_mod_data(mod_lnCVR_ES1_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#ADD8E6") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Sex of animal", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p1_ES_lnCVR

## Outcome_category
mod_lnCVR_ES8_results$mod_table$name <- factor(mod_lnCVR_ES8_results$mod_table$name, levels = c("Anxiety", "Depression"))
results <- prepare_mod_data(mod_lnCVR_ES8_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#FFE4E1") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Outcome category", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p8_ES_lnCVR


## Window_EE_exposure
mod_lnCVR_ES2_results$mod_table$name <- factor(mod_lnCVR_ES2_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_lnCVR_ES2_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#EEDD82") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Exposure window of enrichment", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p2_ES_lnCVR


## Window_stress_exposure
mod_lnCVR_ES3_results$mod_table$name <- factor(mod_lnCVR_ES3_results$mod_table$name, levels = c("Adult", "Adolescent", "Postnatal"))
results <- prepare_mod_data(mod_lnCVR_ES3_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#98FB98") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Exposure window of stress", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p3_ES_lnCVR



# combine
# combine the plots
p <- ((p8_ES_lnCVR + p1_ES_lnCVR) /
        (p2_ES_lnCVR + p3_ES_lnCVR))  +
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D"))  & 
  theme(
    plot.tag = element_text(size = 14, face = "bold") 
  )


## EE_physical
mod_lnCVR_ES4_results$mod_table$name <- factor(mod_lnCVR_ES4_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_ES4_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#CDB7B5") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Physical enrichment?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p4_ES_lnCVR

## EE_social
mod_lnCVR_ES5_results$mod_table$name <- factor(mod_lnCVR_ES5_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_ES5_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#9AC0CD") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Social enrichment?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p5_ES_lnCVR

## Stress_biotic
mod_lnCVR_ES6_results$mod_table$name <- factor(mod_lnCVR_ES6_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_ES6_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#CDBE70") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Biotic stress?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p6_ES_lnCVR


## Stress_abiotic
mod_lnCVR_ES7_results$mod_table$name <- factor(mod_lnCVR_ES7_results$mod_table$name, levels = c("No", "Yes"))
results <- prepare_mod_data(mod_lnCVR_ES7_results)
components <- extract_mod_components(results)
group_no <- length(components$mod_table$name)
mod_table <- components$mod_table
mod_table$g <- as.numeric(mod_table$g$n)


plot_base_quasirandom(components$data_trim, fill_color = "#7CCD7C") +
  add_my_layers(mod_table = mod_table, cbpl = cbpl) +
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.5), label= paste("italic(N)[observation]==", mod_table$K[1:group_no]), parse = TRUE, hjust = "right", size = 3) + 
  annotate('text', y = (0 + (max(components$data_trim$yi)*0.6)), x = (seq(1, group_no, 1)+0.3), label= paste("italic(N)['rodent strain']==", mod_table$g[1:group_no]), parse = TRUE, hjust = "right", size = 3) +
  scale_y_continuous(limits  = c(-1.1, 1.6), expand = c(0,0)) +
  labs(y = bquote("Inter-individual difference"  * " (" * italic(beta)[LnCVR] * ")"), x = " ", title = "Abiotic stress?", subtitle = "Stressed-Enriched \n interaction", size = latex2exp::TeX(components$legend)) +
  theme(axis.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(size = 12, color = "#436EEE")) -> p7_ES_lnCVR




# combine
# combine the plots
p <- ((p4_ES_lnCVR + p5_ES_lnCVR) /
        (p6_ES_lnCVR + p7_ES_lnCVR))  +
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D"))  & 
  theme(
    plot.tag = element_text(size = 14, face = "bold") 
  )
```


### Fig. 4

```{r}
# combine the plots
png(filename = "Fig. 4.png", width = 8, height = 10, units = "in", type = "windows", res = 400)
p <- ((p5_EE_lnRR + p5_EE_lnCVR) /
     (p1_EE_lnRR + p1_EE_lnCVR))  +
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D"))  & 
  theme(
      plot.tag = element_text(size = 14, face = "bold") 
    )
p
dev.off()

```

### Fig. 5

```{r}
# combine the plots
png(filename = "Fig. 5.png", width = 8, height = 12, units = "in", type = "windows", res = 400)
p <- ((p2_EE_lnRR + p2_EE_lnCVR) /
     (p3_EE_lnRR + p3_EE_lnCVR) / 
     (p4_EE_lnRR + p4_EE_lnCVR))  +
  plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = c("A", "B", "C", "D", "E", "F"))  & 
  theme(
      plot.tag = element_text(size = 14, face = "bold") 
    )
p
dev.off()

```



# Supplements

## Tables

```{r}
# table S4
tbl <- data.frame(`Random-effects structure` = c("None","Obs ID","Obs ID + Study ID","Obs ID + Study ID + Spp ID", "Obs ID + Study ID + Spp ID + Phy"),
                      `AICc1` = c(fitstats(null_mod_lnRR)[5],fitstats(mod_lnRR.obsID)[5],fitstats(mod_lnRR.obsID.StudyID)[5],fitstats(mod_lnRR.obsID.StudyID.Spp)[5],fitstats(mod_lnRR.obsID.StudyID.Spp.Phy)[5]),
                      `AICc2` = c(fitstats(null_mod_lnCVR)[5],fitstats(mod_lnCVR.obsID)[5],fitstats(mod_lnCVR.obsID.StudyID)[5],fitstats(mod_lnCVR.obsID.StudyID.Spp)[5],fitstats(mod_lnCVR.obsID.StudyID.Spp.Phy)[5]))

names(tbl)[1] <- "Random-effects structure"

tab.S4 <- tbl %>% flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph("AICc")) %>%
  mk_par(j = 3, part = "header", value = as_paragraph("AICc")) %>% 
  colformat_double(j = c(2,3), digits = 0) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  add_header_row(values = c(" ","lnRR","lnCVR"), colwidths = c(1,1,1)) %>%
  autofit()

#save_as_docx("Table S4" = tab.S4, path ="Supplementary Tables.docx")


# table S5
tbl <- rbind(MLMA_table(MLMA_lnRR), MLMA_table(MLMA_lnCVR))  
row.names(tbl) <- c("Intercept", "Intercept2")
tbl <- tbl %>% mutate(Metric = c("lnRR","lnCVR"))
tbl2 <- tibble::rownames_to_column(tbl,"Coefficient")[,c(8,1,2,3,4,5,6,7)]

tab.S5 <- tbl2 %>% flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(" "))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMA_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>% 
  mk_par(i = 1, j = 2, part = "body", value = as_paragraph("Intercept")) %>% 
  mk_par(i = 2, j = 2, part = "body", value = as_paragraph("Intercept")) %>% 
  colformat_double(j = c(3,4), digits = 2) %>%
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  autofit()


#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, path ="Supplementary Tables.docx")
# https://ardata-fr.github.io/flextable-book/rendering.html

#print(tbl, preview = "docx")

# Table S6
tbl <- h.calc(MLMA_lnRR) 
row.names(tbl) <- c("Total", "Species", "Phylogeny", "Study", "Residual")
# tbl <- tbl %>% mutate(`Cochran's Q` = MLMA_lnRR$QE,df = MLMA_lnRR$QEdf,p = MLMA_lnRR$QEp)
tbl <- tbl %>% mutate(`Cochran's Q test` = "Q(df = 436) = 8680, p-val < .0001",
                      Metric = "lnRR")

tbl2 <- tibble::rownames_to_column(tbl,"Heterogeneity")[,c(7,1:6)]
tab.S6 <- tbl2 %>% flextable() %>% colformat_double(digits = 2) %>% 
  mk_par(j = 3, part = "header", value = as_paragraph(as_i("σ"), as_sup("2"))) %>% 
  mk_par(j = 4, part = "header", value = as_paragraph(as_i("I"), as_sup("2"))) %>%
  mk_par(j = 5, part = "header", value = as_paragraph("CV", as_sub("B"))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph("M", as_sub(""))) %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  colformat_double(j = 3, digits = 2) %>% 
  colformat_double(j = c(4,5,6), digits = 1) %>%
  #colformat_double(j = 6, digits = 0) %>%
  #colformat_double(j = 8, digits = 3) %>%
  #italic(part = "header", j = 8) %>%
  bold(part = "header", bold = T) %>% 
  fontsize(part = "all", size = 10) %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  merge_at(i = 1:5, j = 7) %>% 
  merge_at(i = 1:5, j = 1) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, path ="Supplementary Tables.docx")

# Table S7
tbl <- h.calc(MLMA_lnCVR) 
row.names(tbl) <- c("Total", "Species", "Phylogeny", "Study", "Residual")
# tbl <- tbl %>% mutate(`Cochran's Q` = MLMA_lnRR$QE,df = MLMA_lnRR$QEdf,p = MLMA_lnRR$QEp)
tbl <- tbl %>% mutate(`Cochran's Q test` = "Q(df = 436) = 1019, p-val < .0001",
                      Metric = "lnCVR")

tbl2 <- tibble::rownames_to_column(tbl,"Heterogeneity")[,c(7,1:6)]
tab.S7 <- tbl2 %>% flextable() %>% colformat_double(digits = 2) %>% 
  mk_par(j = 3, part = "header", value = as_paragraph(as_i("σ"), as_sup("2"))) %>% 
  mk_par(j = 4, part = "header", value = as_paragraph(as_i("I"), as_sup("2"))) %>%
  mk_par(j = 5, part = "header", value = as_paragraph("CV", as_sub("B"))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph("M", as_sub(""))) %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  colformat_double(j = 3, digits = 2) %>% 
  colformat_double(j = c(4,5,6), digits = 1) %>%
  #colformat_double(j = 6, digits = 0) %>%
  #colformat_double(j = 8, digits = 3) %>%
  #italic(part = "header", j = 8) %>%
  bold(part = "header", bold = T) %>% 
  fontsize(part = "all", size = 10) %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  merge_at(i = 1:5, j = 7) %>% 
  merge_at(i = 1:5, j = 1) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, path ="Supplementary Tables.docx")


# Table S8
tbl <- MLMR_table(MLMR_2_lnRR,MLMR_2_lnRR2,moderator = "Daytime_or_nighttime_melatonin",group = "Spp", data =dat)
row.names(tbl) <- c("Daytime", "Nighttime", "Delta (N - D)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_2_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S8 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 36) = 9.9, p-val = 0.0004")) %>% 
  autofit()


#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, path ="Supplementary Tables.docx")


# Table S9
tbl <- MLMR_table(MLMR_2_lnCVR,MLMR_2_lnCVR2,moderator = "Daytime_or_nighttime_melatonin",group = "Spp", data =dat)
row.names(tbl) <- c("Daytime", "Nighttime", "Delta (N - D)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_2_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S9 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 36) = 4.2, p-val = 0.0230")) %>% 
  autofit()


#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, path ="Supplementary Tables.docx")

# Table S10
tbl <- MLMR_table(MLMR_3N_lnRR, MLMR_3N_lnRR2, moderator = "grouped_tissue",group = "Spp", data =dat_N)
row.names(tbl) <- c("Central", "Peripheral", "Delta (P - C)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_3N_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S10 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 33) = 7.0, p-val = 0.0029")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, path ="Supplementary Tables.docx")

# Table S11
tbl <- MLMR_table(MLMR_3N_lnCVR, MLMR_3N_lnCVR2, moderator = "grouped_tissue",group = "Spp", data =dat_N)
row.names(tbl) <- c("Central", "Peripheral", "Delta (P - C)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_3N_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S11 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 33) = 7.7, p-val = 0.0018")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, path ="Supplementary Tables.docx")


# Table S12
tbl <- MLMR_table(MLMR_4N_lnRR, MLMR_4N_lnRR2, moderator = "Species_diurnal_nocturnal",group = "Spp", data = dat_N)
row.names(tbl) <- c("Diurnal", "Nocturnal", "Delta (N - D)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_4N_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S12 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 35) = 8.2, p-val = 0.0012")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, path ="Supplementary Tables.docx")

# Table S13
tbl <- MLMR_table(MLMR_4N_lnCVR, MLMR_4N_lnCVR2, moderator = "Species_diurnal_nocturnal",group = "Spp", data = dat_N)
row.names(tbl) <- c("Diurnal", "Nocturnal", "Delta (N - D)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_4N_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S13 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 35) = 8.2, p-val = 0.0012")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, path ="Supplementary Tables.docx")


# Table S14
tbl <- MLMR_table(MLMR_5N_lnRR, MLMR_5N_lnRR2, moderator = "Captive_or_Free_living", group = "Spp", data = dat_N)
row.names(tbl) <- c("Captive", "Free-living", "Delta (F - C)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_5N_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S14 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 35) = 15.2, p-val < .0001")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, "Table S14" = tab.S14, path ="Supplementary Tables.docx")

# Table S15
tbl <- MLMR_table(MLMR_5N_lnCVR, MLMR_5N_lnCVR2, moderator = "Captive_or_Free_living", group = "Spp", data = dat_N)
row.names(tbl) <- c("Captive", "Free-living", "Delta (F - C)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_5N_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S15<- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 35) = 6.3, p-val = 0.0045")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, "Table S14" = tab.S14, "Table S15" = tab.S15, path ="Supplementary Tables.docx")


# Table S16
tbl <- MLMR_table2(MLMR_6N_lnRR)
row.names(tbl) <- c("Intercept", "Intensity")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_6N_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S16 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 266) = 6.7, p-val = 0.0101")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, "Table S14" = tab.S14, "Table S15" = tab.S15, "Table S16" = tab.S16, path ="Supplementary Tables.docx")

# Table S17
tbl <- MLMR_table2(MLMR_6N_lnCVR)
row.names(tbl) <- c("Intercept", "Intensity")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_6N_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S17 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 266) = 1.3, p-val = 0.2627")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, "Table S14" = tab.S14, "Table S15" = tab.S15, "Table S16" = tab.S16, "Table S17" = tab.S17, path ="Supplementary Tables.docx")


# Table S18
tbl <- MLMR_table2(MLMR_6N.lux_lnRR)
row.names(tbl) <- c("Intercept", "Intensity")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_6N.lux_lnRR )[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S18 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 106) = 17.9, p-val < .0001")) %>% 
  autofit()

#save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, "Table S14" = tab.S14, "Table S15" = tab.S15, "Table S16" = tab.S16, "Table S17" = tab.S17, path ="Supplementary Tables.docx")

# Table S19
tbl <- MLMR_table2(MLMR_6N.lux_lnCVR)
row.names(tbl) <- c("Intercept", "Intensity")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_6N.lux_lnCVR )[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S19 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 106) = 3.3, p-val = 0.0732")) %>% 
  autofit()


# Table S20
tbl <- MLMR_table2(MLMR_7N.wave_lnRR)
row.names(tbl) <- c("Intercept", "Wavelength")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_7N.wave_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S20 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 79) = 13.0, p-val = 0.0006")) %>% 
  autofit()


# Table S21
tbl <- MLMR_table2(MLMR_7N.wave_lnCVR)
row.names(tbl) <- c("Intercept", "Wavelength")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_7N.wave_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S21 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 79) = 2.6, p-val = 0.1134")) %>% 
  autofit()


# Table S22
tbl <- MLMR_table(MLMR_7N_lnRR, MLMR_7N_lnRR2, moderator = "Light_colour", group = "Spp", data = dat_N)
row.names(tbl) <- c("White", "Red", "Yellow", "Blue","Delta (R - W)", "Delta (Y - W)", "Delta (B - W)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_7N_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S22 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:7, j = 9) %>%
  merge_at(i = 1:7, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 27) = 5649.5, p-val < .0001")) %>% 
  autofit()


# Table S23
tbl <- MLMR_table(MLMR_7N_lnCVR, MLMR_7N_lnCVR2, moderator = "Light_colour", group = "Spp", data = dat_N)
row.names(tbl) <- c("White", "Red", "Yellow", "Blue","Delta (R - W)", "Delta (Y - W)", "Delta (B - W)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_7N_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S23 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:7, j = 9) %>%
  merge_at(i = 1:7, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 2, df2 = 27) = 2624751309703048.5, p-val < .0001")) %>% 
  autofit()


# Table S24
tbl <- MLMR_table(MLMR_8N_lnRR, MLMR_8N_lnRR2, moderator = "Night_Phase_category", group = "Spp", data = dat_N)
row.names(tbl) <- c("All night", "Late night", "Mid night", "Early night","Delta (L - A)", "Delta (M - A)", "Delta (E - A)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_8N_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S24 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:7, j = 9) %>%
  merge_at(i = 1:7, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 4, df2 = 23) = 3165.6, p-val < .0001")) %>% 
  autofit()


# Table S25
tbl <- MLMR_table(MLMR_8N_lnCVR, MLMR_8N_lnCVR2, moderator = "Night_Phase_category", group = "Spp", data = dat_N)
row.names(tbl) <- c("All night", "Late night", "Mid night", "Early night","Delta (L - A)", "Delta (M - A)", "Delta (E - A)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_8N_lnCVR)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S25 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:7, j = 9) %>%
  merge_at(i = 1:7, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 4, df2 = 23) = 2.8, p-val = 0.0502")) %>% 
  autofit()


# Table S26
tbl <- MLMR_table2(MLMR_9N_lnRR2)
row.names(tbl) <- c("Intercept", "Duration")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_9N_lnRR2)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S26 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 284) = 6702.0, p-val < .0001")) %>% 
  autofit()

# Table S27
tbl <- MLMR_table2(MLMR_9N_lnCVR2)
row.names(tbl) <- c("Intercept", "Duration")
tbl <- tbl %>% mutate(R2 = round(R2_calc(MLMR_9N_lnCVR2)[1],3),
                      Metric = "lnCVR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S27 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:2, j = 9) %>%
  merge_at(i = 1:2, j = 8) %>%
  merge_at(i = 1:2, j = 7) %>%
  merge_at(i = 1:2, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 248) = 1.7, p-val = 0.1903")) %>% 
  autofit()

# Table S30
tbl <- MLMR_table(Study_type_lnRR, Study_type_lnRR2, moderator = "Study_type", group = "Spp", data = dat)
row.names(tbl) <- c("Experiment", "Observation", "Delta (O - E)")
tbl <- tbl %>% mutate(R2 = round(R2_calc(Study_type_lnRR)[1],3),
                      Metric = "lnRR")
tbl2 <- tibble::rownames_to_column(tbl, "Coefficient")[,c(9,1:8)]

tab.S30 <- tbl2 %>%
flextable() %>% 
  align(align = "center", part = "header") %>% 
  align(align = "center", part = "body") %>% 
  mk_par(j = 2, part = "header", value = as_paragraph(as_i("β"), as_sub(""))) %>%
   mk_par(j = 5, part = "header", value = as_paragraph(as_i("t"), as_sub(MLMR_2_lnRR$QMdf[2]))) %>% 
  mk_par(j = 6, part = "header", value = as_paragraph(as_i("p"))) %>%
  mk_par(j = 7, part = "header", value = as_paragraph(as_i("N"),as_sub("species"))) %>%
  mk_par(j = 8, part = "header", value = as_paragraph(as_i("N"),as_sub("obs"))) %>%
  mk_par(j = 9, part = "header", value = as_paragraph(as_i("R"),as_sup("2"))) %>% 
  colformat_double(j = c(3,5), digits = 2) %>% 
  colformat_double(j = 6, digits = 3) %>% 
  bold(part = "header", bold = T) %>% 
  #theme_vanilla() %>% 
  border(part = "body", border = NULL) %>% 
  hline_top(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>% 
  hline_bottom(part = "body", border = officer::fp_border(color = "black", style = "solid", width = 1.5)) %>%
  hline(part = "head", border = officer::fp_border(color = "black", style = "solid", width = 0.5)) %>%
  fontsize(part = "all", size = 10) %>% 
  merge_at(i = 1:3, j = 9) %>%
  merge_at(i = 1:3, j = 1) %>%
  set_caption(caption = as_paragraph("Omnibus test or ", as_i("Q"), as_sub("M")," ","test: F(df1 = 1, df2 = 36) = 1.2, p-val = 0.2889")) %>% 
  autofit()

save_as_docx("Table S4" = tab.S4, "Table S5" = tab.S5, "Table S6" = tab.S6, "Table S7" = tab.S7, "Table S8" = tab.S8, "Table S9" = tab.S9, "Table S10" = tab.S10, "Table S11" = tab.S11, "Table S12" = tab.S12, "Table S13" = tab.S13, "Table S14" = tab.S14, "Table S15" = tab.S15, "Table S16" = tab.S16, "Table S17" = tab.S17, "Table S18" = tab.S18, "Table S19" = tab.S19, "Table S20" = tab.S20, "Table S21" = tab.S21, "Table S22" = tab.S22, "Table S23" = tab.S23, "Table S24" = tab.S24, "Table S25" = tab.S25, "Table S26" = tab.S26, "Table S27" = tab.S27, "Table S28" = tab.S28, "Table S29" = tab.S29, "Table S30" = tab.S30, path ="Supplementary Tables.docx")

```

## Figures

## Fig. S2

```{r}
# plot
png(filename = "Figure S2.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
datlong_fig <- dlong(dat, Strain, Sex, Window_EE_exposure, Window_stress_exposure, Outcome_category)
p <- ggplot(datlong_fig, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  sankey_p(flow.alpha = 0.6, node.color = "transparent") + 
  sankey_p_label(size = 3, color = "white", fill = "gray10", alpha = 0.6) + 
  theme_sankey(base_size = 10) +
  labs(x = NULL, title = " ") +
  theme(legend.position = "none",
        plot.title = element_text(color = "black", size = 12, hjust = .5),
        axis.text.x = element_text(color = "black", size = 12)) +
  scale_x_discrete(labels = c("Strain", "Sex", "Enrichment timing", "Stress timing", "Outcome"), position = "top")
p
dev.off()

```

## Fig. S3

```{r}
# dataframe
pred_dens_data <- pred_dist_data(mod_E0)[-3,]
pred_dens_data$group[1] <- "Strain" 
pred_dens_data$group[2] <- "Between-study" 
pred_dens_data$group[3] <- "Total"
pred_dens_data$threshold <- propT_beyond(pred_dens_data, df = mod_E0$k.all - 1, threshold = 0, tail = "below")

mod_resultsdata <- mod_results(mod_E0, mod = "1", group = "Strain", data = mod_E0$data )$mod_table

# density estimation
density_between <- data.frame(x = seq(-1,1,length.out = 1000)) %>% 
	  mutate(density = c(pred_Tdistri(x, df=mod_E0$k.all-1, m=pred_dens_data$mean[1], sd=pred_dens_data$sd[1]))) %>%
	  mutate(group = rep("Strain", length(x)))
density_total <- data.frame(x = seq(-1,1,length.out = 1000)) %>% 
	  mutate(density = c(pred_Tdistri(x, df=mod_E0$k.all-1, m=pred_dens_data$mean[2], sd=pred_dens_data$sd[2]))) %>%
	  mutate(group = rep("Between-study", length(x)))

png(filename = "Figure S3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
p <- ggplot() +
	  geom_area(data = density_between, aes(x = x, y = density, fill = "Strain"), alpha = 0.3) +
	  geom_area(data = density_total, aes(x = x, y = density, fill = "Between-study"), alpha = 0.3) +
  scale_fill_manual(values = c("#C17F9E", "#8BACD1")) +
	  stat_function(fun = pred_Tdistri_shaded, args = list(df = mod_E0$k.all - 1, m = pred_dens_data$mean[1], sd = pred_dens_data$sd[1], threshold = 0),
	                geom = "area", fill = "#C17F9E", alpha = 0.5) +
	  stat_function(fun = pred_Tdistri_shaded, args = list(df = mod_E0$k.all - 1, m = pred_dens_data$mean[2], sd = pred_dens_data$sd[2], threshold = 0),
	                geom = "area", fill = "#8BACD1",  alpha = 0.5) +
	  theme_bw() + xlim(-1, 1) + labs(fill = "Context") +
	  geom_vline(xintercept = 0, linetype = 2,  colour = "black") +
	  geom_vline(xintercept = mod_resultsdata$lowerPR, linetype = 2,  colour = "red") + 
	  geom_vline(xintercept = mod_resultsdata$upperPR, linetype = 2,  colour = "red") + 
	  annotate("text", x = pred_dens_data$mean[-3] + 0.03, y = c(2.8, 4), label = paste0(round(pred_dens_data$threshold[-3],0), "%"), size = 5) + 
  labs(x = "LnRR", y = "Density") + 
	  theme(legend.position= c(0, 1), 
	        legend.justification = c(0, 1), 
	        legend.background = element_blank(),
	        legend.text = element_text(size = 10),
	        legend.title = element_text(size = 8, face = "bold"),
	        panel.background = element_rect(fill = alpha("#D7C6CA", 0.3), color = NA),
          plot.background = element_rect(fill = "transparent", color = NA)) 
p
dev.off()
```


## Fig. S4

```{r}
# dataframe
pred_dens_data <- pred_dist_data(mod_lnCVR_E0)[-3,]
pred_dens_data$group[1] <- "Strain" 
pred_dens_data$group[2] <- "Between-study" 
pred_dens_data$group[3] <- "Total"
pred_dens_data$threshold <- propT_beyond(pred_dens_data, df = mod_lnCVR_E0$k.all - 1, threshold = 0, tail = "below")
mod_resultsdata <- mod_results(mod_lnCVR_E0, mod = "1", group = "Strain", data = mod_lnCVR_E0$data)$mod_table

# density estimation
density_between <- data.frame(x = seq(-1.5,1.5,length.out = 1000)) %>% 
  mutate(density = c(pred_Tdistri(x, df=mod_lnCVR_E0$k.all-1, m=pred_dens_data$mean[1], sd=pred_dens_data$sd[1]))) %>%
  mutate(group = rep("Strain", length(x)))
density_total <- data.frame(x = seq(-1.5,1.5,length.out = 1000)) %>% 
  mutate(density = c(pred_Tdistri(x, df=mod_lnCVR_E0$k.all-1, m=pred_dens_data$mean[2], sd=pred_dens_data$sd[2]))) %>%
  mutate(group = rep("Between-study", length(x)))

png(filename = "Figure S4.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
p <- ggplot() +
  geom_area(data = density_between, aes(x = x, y = density, fill = "Strain"), alpha = 0.3) +
  geom_area(data = density_total, aes(x = x, y = density, fill = "Between-study"), alpha = 0.3) +
  scale_fill_manual(values = c("#C17F9E", "#8BACD1")) +
  stat_function(fun = pred_Tdistri_shaded, args = list(df = mod_lnCVR_E0$k.all - 1, m = pred_dens_data$mean[1], sd = pred_dens_data$sd[1], threshold = 0),
                geom = "area", fill = "#C17F9E", alpha = 0.5) +
  stat_function(fun = pred_Tdistri_shaded, args = list(df = mod_lnCVR_E0$k.all - 1, m = pred_dens_data$mean[2], sd = pred_dens_data$sd[2], threshold = 0),
                geom = "area", fill = "#8BACD1",  alpha = 0.5) +
  theme_bw() + xlim(-1.5, 1.5) + labs(fill = "Context") +
  geom_vline(xintercept = 0, linetype = 2,  colour = "black") +
  geom_vline(xintercept = mod_resultsdata$lowerPR, linetype = 2,  colour = "red") + 
  geom_vline(xintercept = mod_resultsdata$upperPR, linetype = 2,  colour = "red") + 
  annotate("text", x = pred_dens_data$mean[-3] + 0.03, y = c(2, 6), label = paste0(round(pred_dens_data$threshold[-3],0), "%"), size = 5) + 
  labs(x = "LnCVR", y = "Density") + 
  theme(legend.position= c(0, 1), 
        legend.justification = c(0, 1), 
        legend.background = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 8, face = "bold"),
        panel.background = element_rect(fill = alpha("#E0FFFF", 0.8), color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) 
p
dev.off()
```

## Fig. S5

```{r}
png(filename = "Figure S5.png", width = 6.5, height = 4, units = "in", type = "windows", res = 400)
vip_predictors <- res$variable_importance %>%
  arrange(weight) %>%
  mutate(predictor = factor(predictor, levels = predictor)) %>% dfround(3)  

 ggplot(vip_predictors, aes(x = predictor, y = weight, size = weight)) +
  geom_segment(aes(x = predictor, xend = predictor, y = 0, yend = weight),
               color = "#87CEFA", size = 1) +
  geom_point(size = 10, color = "steelblue") +
  coord_flip() +
  theme_bw() +
  labs(y = "Akaike weights", x = "Moderator variables", title = "") +
  #ylim(0,1)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  #coord_cartesian(ylim = c(0,1)) + 
  geom_text(aes(label=scales::percent(weight, accuracy = 1)), size = 3, color = "black") +
  theme(legend.position = "none",
        axis.text = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 12, color = "black")) +
  scale_x_discrete(labels = c("Sex", "Outcome category", "Physical enrichment", "Social enrichment", "Exposure window"))
dev.off()

# tableS6
tbl <- res$multimodel_inference
row.names(tbl) <- c("Intercept", "Adult", "Postnatal", "Social enrichment", "Physical enrichment", "Depression", "Male", "Mixed")
tbl2 <- data.frame(Coefficient = row.names(tbl), Estimate = tbl$Estimate, CI = sprintf("[%0.2f, %0.2f]", tbl$ci.lb, tbl$ci.ub), z = tbl$z, p = tbl$p, Importance = tbl$Importance)
names(tbl2)[3] <- "95% CI"
```


```{r}
# Figure S7
# getting blups (best linear predictors from the model) for lnRR
blups <- ranef(MLMA_lnRR) 
t.spp <- blups$Spp # this needs to be added
t.phy <- blups$Phy
t.study <- blups$StudyID # study
t.spp <- rownames_to_column(t.spp, var = "Species")
t.phy <- rownames_to_column(t.phy, var = "Species")
t.spp$Species <- t.phy$Species # uppercase
t.study <- rownames_to_column(t.study, var = "Study") # study

# average species
colnames(t.spp) <- c("Species", "Deviation", "SE", "Lower_bound", "Upper_bound")
colnames(t.phy) <- c("Species", "Deviation", "SE", "Lower_bound", "Upper_bound")
colnames(t.study) <- c("Study", "Deviation", "SE", "Lower_bound", "Upper_bound")

# sorting match between study and species
dat %>% group_by(StudyID) %>% summarise(Species = unique(Phy)) -> dat_match # warning information: https://stackoverflow.com/questions/62140483/how-to-interpret-dplyr-message-summarise-regrouping-output-by-x-override

index <- match(dat_match$Species, t.spp$Species)

spp.mean <- rep(MLMA_lnRR$b, dim(t.spp)[1]) + t.spp$Deviation + t.phy$Deviation
spp.se <- sqrt(MLMA_lnRR$se^2 + t.spp$SE^2 +  t.phy$SE^2) 
spp.lb <- spp.mean - spp.se * qnorm(0.975) 
spp.ub <- spp.mean + spp.se * qnorm(0.975)
re.spp <- tibble(Species = t.spp$Species, Mean = spp.mean, SE = spp.se, Lower_bound = spp.lb, Upper_bound = spp.ub) %>% arrange(Species)
N_obs <- dat %>% group_by(Phy) %>% summarise(N_obs=n()) # calculate sample size
names(N_obs)[1] <- "Species"
re.spp.lnRR <- left_join(re.spp,N_obs,by = "Species")
tip.label <- data.frame(Species = my.tr$tip.label) # extract tip label
re.spp.lnRR2 <- left_join(tip.label,re.spp.lnRR,by = "Species") 


# getting blups (best linear predictors from the model) for lnCVR
blups <- ranef(MLMA_lnCVR) 
t.spp <- blups$Spp # this needs to be added
t.phy <- blups$Phy
t.study <- blups$StudyID # study
t.spp <- rownames_to_column(t.spp, var = "Species")
t.phy <- rownames_to_column(t.phy, var = "Species")
t.spp$Species <- t.phy$Species # uppercase
t.study <- rownames_to_column(t.study, var = "Study") # study

# average species
colnames(t.spp) <- c("Species", "Deviation", "SE", "Lower_bound", "Upper_bound")
colnames(t.phy) <- c("Species", "Deviation", "SE", "Lower_bound", "Upper_bound")
colnames(t.study) <- c("Study", "Deviation", "SE", "Lower_bound", "Upper_bound")

# sorting match between study and species
dat %>% group_by(StudyID) %>% summarise(Species = unique(Phy)) -> dat_match # warning information: https://stackoverflow.com/questions/62140483/how-to-interpret-dplyr-message-summarise-regrouping-output-by-x-override

index <- match(dat_match$Species, t.spp$Species)

spp.mean <- rep(MLMA_lnCVR$b, dim(t.spp)[1]) + t.spp$Deviation + t.phy$Deviation
spp.se <- sqrt(MLMA_lnCVR$se^2 + t.spp$SE^2 +  t.phy$SE^2) 
spp.lb <- spp.mean - spp.se * qnorm(0.975) 
spp.ub <- spp.mean + spp.se * qnorm(0.975)
re.spp <- tibble(Species = t.spp$Species, Mean = spp.mean, SE = spp.se, Lower_bound = spp.lb, Upper_bound = spp.ub) %>% arrange(Species)
N_obs <- dat %>% group_by(Phy) %>% summarise(N_obs=n()) # calculate sample size
names(N_obs)[1] <- "Species"
re.spp.lnCVR <- left_join(re.spp,N_obs,by = "Species")
tip.label <- data.frame(Species = my.tr$tip.label) # extract tip label
re.spp.lnCVR2 <- left_join(tip.label,re.spp.lnCVR,by = "Species") 



# get class data
spp.class <- dplyr::distinct(dat, Phy, .keep_all = TRUE) %>% dplyr::select(Class, Phy)
names(spp.class)[2] <- "Species"

spp.class2 <- left_join(tip.label,spp.class,by = "Species")

# Actinopterygii and Osteichthyes all belong to fish, although there are differnt. In our dataset, only Actinopterygii only has one estimate. To make the figure easy, we change Actinopterygii to Osteichthyes 
spp.class2$Class[spp.class2$Class == "Actinopterygii"] <- "Osteichthyes"

# version 2
p1 <- ggtree(my.tr, branch.length = "branch.length") 
# https://yulab-smu.top/treedata-book/chapter7.html  
p2 <- p1 %<+% spp.class2 + geom_tiplab(aes(color  = Class),size=3,fontface = "italic") + geom_tippoint(aes(color=Class)) + xlim_expand(c(0,3), panel = "Tree") + guides(color="none")  # xlim issue https://stackoverflow.com/questions/48928250/ggtreefacet-plot-second-panel-uses-xlim-parameter-from-first-one
p3 <- facet_plot(p2, panel = 'N observations', data = re.spp.lnRR2, 
				geom = geom_barh, 
				mapping = aes(x = N_obs,fill=Class,color=Class), alpha = 0.4, stat='identity') +  guides(fill="none",color="none") + # #0072B2 https://yulab-smu.top/treedata-book/chapter12.html,
  geom_facet(panel = "Estimates of mean ratio (lnRR)", data = re.spp.lnRR2,
           geom = ggstance::geom_pointrangeh, # geom_pointrange
           mapping = aes(x = Mean, xmin = Lower_bound, xmax = Upper_bound, color = Class)) + # #CC79A7
  # add overall effect MLMA_lnRR$b
  geom_facet(panel = "Estimates of mean ratio (lnRR)", data = re.spp.lnRR2,
           geom = geom_vline, 
           mapping = aes(xintercept = -0.45),linetype="dashed",color="grey") +  # add multiple panels or multiple layers on the same panels (Figure 13.1) # https://yulab-smu.top/treedata-book/chapter7.html - at Chapter 13
  geom_facet(panel = "Estimates of CV ratio (lnCVR)", data = re.spp.lnCVR2,
           geom = ggstance::geom_pointrangeh, 
           mapping = aes(x = Mean, xmin = Lower_bound, xmax = Upper_bound, color = Class)) + 
  # add overall effect MLMA_lnCVR$b
  geom_facet(panel = "Estimates of CV ratio (lnCVR)", data = re.spp.lnRR2,
           geom = geom_vline, 
           mapping = aes(xintercept = 0.21), linetype="dashed",color="grey") + 
  theme_tree2() + theme(strip.background = element_rect(fill = "white"))

# lbs <- c(Tree = "Phylogenetic tree") # change facet name # https://guangchuangyu.github.io/cn/2018/09/facet_labeller/
# p3 <- ggtree::facet_labeller(p3,lbs)
p4 <- facet_widths(p3, c(Tree=0.7,`N observations`=0.2,`Estimates of mean ratio (lnRR)`=0.4,`Estimates of CV ratio (lnCVR)`=0.4)) # set the widths of specific panels (it also supports using a name vector)

png(filename = "Figure S7 (Phy est).png", width = 8, height = 6, units = "in", type = "windows", res = 400)
p4
dev.off()


# Figure S8
Q7_color_lnRR <- orchard_plot(MLMR_7N_lnRR, 
             mod = "Light_colour", 
             alpha = 0.9, angle = 0,
             xlab = "Response magnitude (mean ratio)", #transfm = "exp",
             group = "Species", k = TRUE, g = TRUE,
             trunk.size = 1, branch.size = 0.5, twig.size = 1, errorbar = 0.1, precision.size = 2.5,
             legend.pos = "bottom.right",
             data = dat_N) +
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.title = element_text(size = 5),
        legend.text = element_text(size = 5)) + 
  #scale_y_continuous(limits = c(-3,1.5)) +
  scale_fill_manual(values = c("white","red","#F0E442","blue"))

Q7_color_lnCVR <- orchard_plot(MLMR_7N_lnCVR, 
             mod = "Light_colour", 
             alpha = 0.9, angle = 0,
             xlab = "Response variability (CV ratio)", #transfm = "exp",
             group = "Species", k = TRUE, g = TRUE,
             trunk.size = 1, branch.size = 0.5, twig.size = 1, errorbar = 0.1, precision.size = 2.5,
             legend.pos = "bottom.right",
             data = dat_N) +
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.title = element_text(size = 5),
        legend.text = element_text(size = 5)) + 
  #scale_y_continuous(limits = c(-2,3)) +
  scale_fill_manual(values = c("white","red","#F0E442","blue"))


png(filename = "Figure S8 (color).png", width = 8, height = 5, units = "in", type = "windows", res = 400)
(Q7_color_lnRR  | Q7_color_lnCVR) + plot_annotation(tag_levels = "A")
dev.off()


# Figure S9
Q8_phase_lnRR <- orchard_plot(MLMR_8N_lnRR, 
             mod = "Night_Phase_category", 
             alpha = 0.9, angle = 0,
             xlab = "Response magnitude (mean ratio)", #transfm = "exp",
             group = "Species", k = TRUE, g = TRUE,
             trunk.size = 1, branch.size = 0.5, twig.size = 1, errorbar = 0.1, precision.size = 2.5,
             legend.pos = "bottom.right",
             data = dat_N) +
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.title = element_text(size = 5),
        legend.text = element_text(size = 5)) +
  paletteer::scale_fill_paletteer_d("nord::aurora")

Q8_phase_lnCVR <- orchard_plot(MLMR_8N_lnCVR, 
             mod = "Night_Phase_category", 
             alpha = 0.9, angle = 0,
             xlab = "Response variability (CV ratio)", #transfm = "exp",
             group = "Species", k = TRUE, g = TRUE,
             trunk.size = 1, branch.size = 0.5, twig.size = 1, errorbar = 0.1, precision.size = 2.5,
             legend.pos = "bottom.right",
             data = dat_N) +
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.title = element_text(size = 5),
        legend.text = element_text(size = 5)) +
  paletteer::scale_fill_paletteer_d("nord::aurora")

png(filename = "Figure S9 (phase).png", width = 8, height = 5, units = "in", type = "windows", res = 400)
(Q8_phase_lnRR | Q8_phase_lnCVR) + plot_annotation(tag_levels = "A")
dev.off()

# Figure S10
Q9_duration_lnRR <- bubble_plot(MLMR_9N_lnRR2, 
            mod = "Exposure_duration", 
            xlab = "Experimental duration of ALAN (days)", ylab = "Response magnitude (mean ratio)",
            group = "Species", k = TRUE, g = TRUE,
            ci.col = "black", pi.col = "black", bubble.col = "#D55E00",
            data = dat_N, legend.pos = "bottom.right") +
            theme(axis.text.x = element_text(size = 12, colour = "black"), axis.text.y = element_text(size = 12, colour = "black"), axis.title.x = element_text(size = 12, colour = "black"), plot.title = element_text(size = 12, colour = "black")) +
  theme(panel.grid = element_blank())

Q9_duration_lnCVR <- bubble_plot(MLMR_9N_lnCVR, 
            mod = "Extended_hours", 
            xlab = "Daily duration of ALAN (hours)", ylab = "Response variability (CV ratio)",
            group = "Species", k = TRUE, g = TRUE,
            ci.col = "black", pi.col = "black", bubble.col = "#D55E00",
            data = dat_N, legend.pos = "bottom.right") +
            theme(axis.text.x = element_text(size = 12, colour = "black"), axis.text.y = element_text(size = 12, colour = "black"), axis.title.x = element_text(size = 12, colour = "black"), plot.title = element_text(size = 12, colour = "black")) +
  theme(panel.grid = element_blank())

png(filename = "Figure S10 (duration).png", width = 8, height = 5, units = "in", type = "windows", res = 400)
(Q9_duration_lnRR | Q9_duration_lnCVR) + plot_annotation(tag_levels = "A")
dev.off()
```


## Fig. S6

```{r}
# funnel
png(filename = "Figure S6.png", width = 10, height = 5, units = "in", type = "windows", res = 400)
par(mfrow=c(1,2))
funnel(funnel1 , yaxis = 'seinv',level = c(95),shade = c('white'),legend = F,pch = 21,refline = 0,xlab = "LnRR", ylab = "Precision") 
funnel(funnel2 , yaxis = 'seinv',level = c(95),shade = c('white'),legend = F,pch = 21,refline = 0, xlab = "LnRR", ylab = "Precision") 
dev.off()
```

## Fig. S7

```{r}
png(filename = "Figure S7.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
res <- mod_results(pbc_lnRR, mod = "1", group = "Strain", data = pbc_lnRR$data)
p <- orchard_plot(res, group = "Strain",  xlab = "LnRR") +
  scale_x_discrete(labels = c("")) + ylim(-2,3)
p2 <- pub_bias_plot(p, pbc_lnRR2)
p2
dev.off()
```

## Fig. S8

```{r}
png(filename = "Figure S8.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
res <- mod_results(pb_lnRR, mod = "Year_pub.c", group = "Strain", data = pb_lnRR$data)
mod_table <- res$mod_table
ggplot(mod_table, aes(x = moderator, y = estimate)) +
  geom_smooth(aes(x = moderator, y = lowerPR), method =  "loess", formula = y~x, se = FALSE, lty =  "dotted", ) +
  geom_smooth(aes(x = moderator, y = upperPR), method =  "loess", formula = y~x,se = FALSE, lty = "dotted") +
  geom_smooth(aes(x = moderator, y = lowerCL), method =  "loess", formula = y~x,se = FALSE,lty = "dashed") +
  geom_smooth(aes(x = moderator, y = upperCL), method =  "loess", formula = y~x,se = FALSE, lty ="dashed") +
  geom_smooth(aes(x = moderator, y = estimate), method =  "loess", formula = y~x, se = FALSE) +
  theme_bw() +
  labs(x = "Publication year (centered)" , y = "LnRR")
dev.off()

```

## Fig. S9

```{r}
png(filename = "Fig. S9.png", width = 6.5, height = 6, units = "in", type = "windows", res = 400)
leave1out.p <- ggplot(leave1out_results) +
  geom_hline(yintercept = 0, lty = 2, lwd = 0.75, colour = "lightgrey") +
  geom_hline(yintercept = mod_E0$ci.lb, lty = 3, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_E0$b, lty = 1, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_E0$ci.ub, lty = 3, lwd = 0.75, colour = "black") +
  geom_pointrange(aes(x = left_out, y = est, ymin = lower, ymax = upper),color = "#009E73") +
  xlab("rodent strain left out") + 
  ylab("LnRR (95% CI)") + 
  coord_flip() +
  theme(panel.grid.minor = element_blank())+
  theme_bw() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.x = element_line(colour = "black")) +
  theme(axis.text.y = element_text(size = 10))
leave1out.p
dev.off()
```

## Fig. S11

```{r}
png(filename = "Figure S11.png", width = 6.5, height = 6, units = "in", type = "windows", res = 400)
r.dat <- data.frame(mean = c(datV$CC_mean,datV$EC_mean,datV$CS_mean,datV$ES_mean),
                    SD = c(datV$CC_SD,datV$EC_SD,datV$CS_SD,datV$ES_SD),
                    group = c(rep("Control",length(datV$CC_mean)), rep("EE",length(datV$EC_mean)), rep("Stress",length(datV$CS_mean)), rep("Stress + EE",length(datV$ES_mean))))


r.dat %>% ggplot(aes(x = log(mean), y = log(SD), color = group)) +
  geom_point() + 
  labs(x = "Mean in control group (log scale)", y = "SD in control group (log scale)") + 
  theme_bw() 
dev.off()
```


# Software and package versions

```{r}
knitr::kable(installed.packages()[names(sessionInfo()$otherPkgs), "Version"], "pipe")
```

|               |x          |
|:--------------|:----------|
|extraDistr     |1.9.1      |
|formatR        |1.11       |
|pander         |0.6.4      |
|gridGraphics   |0.5-1      |
|png            |0.1-7      |
|ggsci          |2.9        |
|distributional |0.3.1      |
|paletteer      |1.5.0      |
|viridis        |0.6.2      |
|viridisLite    |0.4.0      |
|wesanderson    |0.3.6      |
|aplot          |0.1.8      |
|patchwork      |1.1.1      |
|cowplot        |1.1.1      |
|ggthemr        |1.1.0      |
|visdat         |0.5.3      |
|ggsignif       |0.6.3      |
|ggdist         |3.2.0      |
|ggpubr         |0.4.0      |
|progress       |1.2.2      |
|emmeans        |1.6.3      |
|BayesFactor    |0.9.12-4.7 |
|coda           |0.19-4     |
|metafor        |4.7-53     |
|numDeriv       |2016.8-1.1 |
|metadat        |1.2-0      |
|Matrix         |1.5-3      |
|glmulti        |1.0.8      |
|leaps          |3.1        |
|rJava          |1.0-4      |
|MuMIn          |1.43.17    |
|clubSandwich   |0.5.11     |
|here           |1.0.1      |
|readxl         |1.3.1      |
|forcats        |0.5.2      |
|stringr        |1.5.0      |
|dplyr          |1.0.10     |
|purrr          |0.3.4      |
|readr          |2.1.2      |
|tidyr          |1.2.1      |
|tibble         |3.1.8      |
|ggplot2        |3.4.4      |
|tidyverse      |1.3.1      |